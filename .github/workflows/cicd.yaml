name: Azure AKS CI/CD Pipeline

on:
  push:
    branches:
      - main

env:
  ACR_NAME: ${{ secrets.ACR_NAME }}
  ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
  RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}
  AKS_CLUSTER: ${{ secrets.AKS_CLUSTER }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Checkout repo
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2️⃣ Azure Login
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # 3️⃣ Login to ACR
    - name: ACR Login
      run: |
        az acr login --name $ACR_NAME

    # 4️⃣ Build & Push Backend
    - name: Build & Push Backend Image
      run: |
        docker build -t $ACR_LOGIN_SERVER/backend:latest ./backend
        docker push $ACR_LOGIN_SERVER/backend:latest

    # 5️⃣ Build & Push Frontend
    - name: Build & Push Frontend Image
      run: |
        docker build -t $ACR_LOGIN_SERVER/frontend:latest ./frontend
        docker push $ACR_LOGIN_SERVER/frontend:latest

    # 6️⃣ Set AKS Context
    - name: Get AKS Credentials
      run: |
        az aks get-credentials \
          --resource-group $RESOURCE_GROUP \
          --name $AKS_CLUSTER \
          --overwrite-existing

    # 7️⃣ Deploy to Kubernetes
    - name: Deploy Kubernetes Manifests
      run: |
        kubectl apply -f k8s/

    # 8️⃣ Verify rollout
    - name: Verify Deployment
      run: |
        kubectl rollout status deployment/backend -n devops-app
        kubectl rollout status deployment/frontend -n devops-app
